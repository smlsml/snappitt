<div class="experience_header">
  <div class="stats">
    <dfn class="views" title="Views"><span></span><var><%= @experience.views %></var></dfn>
    <dfn class="likes" title="Tags"><span></span><var><%= @experience.likes_count %></var></dfn>
    <dfn class="comments" title="Comments"><span></span><var><%= @experience.comments_count %></var></dfn><br>
  </div>

  <fieldset class="header">
    <legend>Experience #<%= @experience.id %></legend>

    <div class="main">
      <h1><%= link_to(@experience.title, experience_path(@experience)) %></h1>

      <div class="details">
        <dfn><var><%= @experience.moments_count %></var> moments in this experience from&hellip;</dfn>
      </div>

      <div class="collaborators">
        <% @experience.collaborators.each do |c| %>
          <%= user_icon(c.user, :thumb)%>
        <% end %>
      </div>

      <div class="side">
        <div class="add">
          <span>Email more photos to</span>
          <h3><a href="mailto:<%= 'post%s@snappitt.com' % @experience.id %>"><%= 'post%s@snappitt.com' % @experience.id %></a></h3>
        </div>
        <%= link_to('Add Moment', edit_experience_path(@experience), :class => 'button') %>
        <%= link_to('Delete Experience', experience_path(@experience), :class => 'button', :method => :delete, :confirm => 'Are you sure?') if can_edit?(@experience.user) %>
      </div>

    </div>

  </fieldset>
</div>


<% cnt = @experience.moments.count + 1 %>
<% @experience.moments.each do |m| %>
  <a name="<%= m.id %>"></a>
  <div class="moment_card">
    <h2>
      <span class="time"><%= m.time %></span>
      <small><%= m.created_at.to_formatted_s(:mdy) %></small>
    </h2>

    <div class="number">moment #<%= cnt -= 1 %></div>
    <div class="moment">
      <div class="photo"><%= image_tag(m.photo_url(:large), :class => 'photo') %>
        <%= ('<img src="%s" class="published"/>' % SiteAssets[:published]).html_safe if m.published? %>
      </div>

      <p class="metadata">
        <% if m.asset %>
          <%= 'Taken' if m.asset.taken_at || m.asset.device || m.asset.lat %>
          <%= ' with %s' % m.asset.device if m.asset.device %>
          <%= (' near <a href="http://maps.google.com/?q=%s,%s" target="_blank">%s</a>' % [m.asset.lat, m.asset.lng, m.asset.geolocation]).html_safe if m.asset.lat %>
        <% end %>
      </p>

      <div class="actions">
        <div class="button l">
          <%= link_to('Publish', publish_experience_moment_path(@experience, m)) if !m.published? && can_publish? %>
        </div>

        <%= select(:like,
                   :shot,
                   LikeFlag::SHOTS,
                   {:prompt => "Tag Photo:",
                    :selected => m.likes.by_user(current_user).first.try(:shot)},
                   {:id => 'like_%s' % m.id,
                    :onchange => "new Ajax.Request('%s?shot='+this.value, {method: 'get', onSuccess: function(transport) {new Effect.Highlight(this.up())}.bind(this)})" % like_experience_moment_path(@experience, m)}) %>

        <div class="button r">
          <%= link_to('Delete', experience_moment_path(@experience, m), :method => :delete, :confirm => 'Are you sure?') if can_edit?(m.user) || can_edit?(@experience.user) %>
        </div>
      </div>

    </div>

    <table class="comment" width="100%">
    <% if m.likes.count > 0 %>
      <% m.grouped_flags.each do |shot, users| %>
      <tr>
        <th><%= user_icon(users.first, :tiny) %></th>
        <td colspan="2" class="text">
          <%= users.uniq.to_sentence %> tagged this photo as <%= shot %>
        </td>
      </tr>
      <% end %>
    <% end %>
    <% m.comments.each do |c| %>
      <tr>
        <th><%= user_icon(c.user, :tiny) %></th>
        <td colspan="2" class="text">
          <span class="user"><%= user_link(c.user) %></span>
          <%= quoted_comment(c.text) %>
        </td>
      </tr>
    <% end %>
      <tr>
        <th></th>
        <td colspan="2">
          <%= form_for(:moment, :url => comment_experience_moment_path(@experience, m)) do %>
            <textarea name="comment" rows="1" cols="55" class="auto"></textarea>
            <input type="submit" value="Add Comment"/><br/>
          <% end %>
        </td>
      </tr>
    </table>

  </div>
<% end %>

<% if @causes %>

<fieldset>
  <legend>Recent Activity</legend>
  <div class="activity">
    <ol>
      <% @causes.each do |action| %>
        <li><%= action.summary(Cause::Decorator.new(@user)) %></li>
      <% end %>
    </ol>
  </div>
</fieldset>

<% end %>
