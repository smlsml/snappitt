<div class="experience_header">
  <img class="icon" src="<%= @experience.user.profile.photo_url %>" alt="<%= @experience.user %>"/>

  <h2><%= @experience.title %></h2>

  <div class="details">
    <var><%= @experience.moments_count %></var> moments <!-- at
    <var>X</var> places with
    <var>X</var> people and
    <var>X</var> things -->
  </div>

  <div class="by">
    By <%= link_to(@experience.user, user_path(@experience.user), :title => @experience.user.profile.realname) %> &nbsp;
    <dfn><var><%= @experience.user.experiences_count %></var> Experiences</dfn> &bull;
    <dfn><var><%= @experience.user.followers.count %></var> Followers</dfn>
  </div>

  <div class="stats">
    <dfn class="views" title="Views"><span></span><var><%= @experience.views %></var></dfn>
    <dfn class="likes" title="Likes"><span></span><var><%= @experience.likes_count %></var></dfn>
    <dfn class="comments" title="Comments"><span></span><var><%= @experience.comments_count %></var></dfn>
  </div>
</div>

<% @experience.moments.each do |m| %>
  <div class="moment_card">
    <div class="moment">
    <%= image_tag(m.photo_url(:large), :class => 'photo') %>
    <%= ('<img src="%s" class="published"/>' % SiteAssets[:published]).html_safe if m.published? %>
    </div>

    <p class="links">
      <%= link_to('Publish', publish_experience_moment_path(@experience, m)) if !m.published? && can_publish? %> &nbsp;
      <%= link_to('Like', like_experience_moment_path(@experience, m)) %> &nbsp;
      <%= link_to('Delete', experience_moment_path(@experience, m), :method => :delete, :confirm => 'Are you sure?') if can_edit?(m.user) || can_edit?(@experience.user) %>
    </p>

    <blockquote><%= (t(:lq).html_safe << m.caption << t(:rq).html_safe) unless m.caption.blank? %></blockquote>

    <p class="metadata">
      Uploaded at <%= m.created_at.to_formatted_s(:mdy) %> by
      <%= link_to(m.user, user_path(m.user), :title => m.user.profile.realname) %>
      <%= (' via <span title="%s" class="source">%s&deg;</span>' % [m.source.name, m.source.short]).html_safe if m.source %>
      <% if m.asset %>
        <br/>
        <%= 'Taken' if m.asset.taken_at || m.asset.device || m.asset.lat %>
        <%= 'on %s' % m.asset.taken_at.to_formatted_s(:mdy) if m.asset.taken_at %>
        <%= ' with %s' % m.asset.device if m.asset.device %>
        <%= (' near <a href="http://maps.google.com/?q=%s,%s" target="_blank">%s</a>' % [m.asset.lat, m.asset.lng, m.asset.geolocation]).html_safe if m.asset.lat %>
      <% end %>
    </p>

    <fieldset>
      <legend>Comments</legend>
      <%= form_for(:moment, :url => comment_experience_moment_path(@experience, m)) do %>
        <textarea name="comment" rows="2" cols="60" class="auto"></textarea><br/>
        <input type="submit" value="Add Comment"/><br/>
      <% end %>

      <table class="comment">
      <% if m.likes.count > 0 %>
      <% first_like = m.likes.first %>
        <tr>
          <td>
            <%= link_to(image_tag(first_like.user.profile.photo_url,
                                  :width => 24,
                                  :height => 24,
                                  :alt => first_like.user),
                        user_path(first_like.user)) %>
          </td>
          <td><%= link_to(first_like.user, user_path(first_like.user)) %></td>
          <td class="text"><%= m.likes.count > 1 ? (' and %s others' % (m.likes.count - 1)) : '' %> liked this moment</td>
        </tr>
      <% end %>
      <% m.comments.each do |c| %>
        <tr>
          <td>
            <%= link_to(image_tag(c.user.profile.photo_url,
                                  :width => 24,
                                  :height => 24,
                                 :alt => c.user),
                        user_path(c.user)) %>
          </td>
          <td><%= link_to(c.user, user_path(c.user)) %></td>
          <td class="text">"<%= c.text %>"</td>
        </tr>
      <% end %>
      </table>

    </fieldset>
    <br/><br/>
  </div>
<% end %>

<%= link_to('Add Moment', edit_experience_path(@experience), :class => 'button') %> &nbsp;&nbsp;
<%= link_to('Delete Experience', experience_path(@experience), :class => 'button', :method => :delete, :confirm => 'Are you sure?') if can_edit?(@experience.user) %>

<% if @causes %>
<div class="activity">
<h2>Recent Activity</h2>
  <ol>
    <% @causes.each do |action| %>
      <li><%= action.summary %></li>
    <% end %>
  </ol>
</div>
<% end %>
